## **Overview**

[In a report dated July 11, 2023](https://www.microsoft.com/en-us/security/blog/2023/07/11/storm-0978-attacks-reveal-financial-and-espionage-motives/), Microsoft identified a phishing campaign targeting government and defense organizations in Europe and North America. The campaign operates by abusing the vulnerability CVE-2023-36884, which uses a phishing email with a malicious Word document that exploits a remote code execution (RCE) vulnerability. The lure of the phishing emails is related to the Ukranian World Congress.

Threat actor group **Storm-0978**, also known as RomCom, is a Russian-based cybercriminal group that's known to focus its operations on ransomware and extortion. They've also been associated with the RomCom backdoor, hence their namesake.

## **Phishing**

The attack successfully took place because one or more individuals at the NATO Summit downloaded a malicious Word document that they believed to be genuine. Similar attacks were identified by Microsoft to target telecommunications and finance sectors as well, with these being largely opportunistic.

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/e37eb5f7-2316-489f-a926-84e9e31e6907)

Source: https://www.microsoft.com/en-us/security/blog/2023/07/11/storm-0978-attacks-reveal-financial-and-espionage-motives/

The initial email sent to individuals at the Summit contained two links to `doc` files that could be downloaded, with the instructions stipulating that the recipients needed to fill in forms and read the overview sheet.


![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/eec922dc-f22d-4d8d-8832-0c38f4c59cd5)

Source: https://www.microsoft.com/en-us/security/blog/2023/07/11/storm-0978-attacks-reveal-financial-and-espionage-motives/

Once opened, the document contained talking points for a discussion around the Ukrainian World Congress' Ukraine In Nato campaign.


## **Exploit chain**

There are many steps in the exploit flow. Depending on the patch status or installed version of Office, there are a number of potential steps. A researcher at Volexity released a graphic showing the full exploit chain. This is shown below.

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/0d408e79-a7aa-40e4-ba45-8ed6575871ef)

Source: https://twitter.com/r00tbsd/status/1679042071477338114/photo/1

## **Document analysis**


### **Metadata**

Office documents provide a large amount of metadata that can be used to correlate attacks from threat actors across campaigns. This metadata can be helpful where elements like the name of a document or the contents change, but the computer account used to create the document remains the same. `ExifTool` can read these metadata entries for old and new Office documents.

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/8a332fb7-e78c-44c5-9c0f-3af853dce539)

ExifTool output showing metadata for an Office document

Interesting metadata elements include:

* Creation date
* Modified date
* Last modified by


### **Parsing Office documents**

There are several methods to parse the contents of an Office document, depending on the file type. Office documents have several supported formats.

* OLE: This is the legacy format for Office documents before 2017. This file type stores the elements of a document as binary objects.
* XML: This newer format replaces OLE files and uses mostly XML structured data files to store the elements of documents. These XML components are all compressed using the zip format.
* RTF: This format was used as a step up from plain text files; the Rich Text Format could include formatting information like bold or italics alongside the content.
* HTML/XML: Office documents can also be written in web-based structures like HTML, CSS, and XML. If given a `.doc` the extension will open and render inside Office applications.

Several file extensions can be switched, and Office will still correctly load and determine the correct renderer.

Informative Alert

You can change the file extension of new-format Office documents to `.zip` and then access all the embedded files using a standard archive tool like `unzip`. OLE-type files require a special parser like `oletools` to extract the embedded objects.


### **Zip/XML structure**

There are a few key filetypes that are found in modern Office XML formatted documents:

* `[Content_Types].xml` – defines the content types and overrides for the document
* `_rels/.rels` – defines relationships between objects and components
* `docProps/core.xml` – properties relating to the document
* `word/document.xml` – the central part of the Word document

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/3e3a2754-9089-4202-a372-4521953651c8)

Zip archive view of an office document

Alongside these core components, the archive will contain all the embedded components like files, images, or other embedded objects like RTFs, macros, or documents.

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/dd729dc1-6b15-493d-a5ff-01964bffbe38)

Zipdump view of an office document


### **Oletools**

Several individual tools make up the `oletools` bundle. Most are designed to work on legacy formats like `ole`, but some tools can process other formats like zip, XML, and RTF.

#### **Tools to analyze malicious documents**

* `oleid` – analyzes OLE files to detect specific characteristics usually found in malicious files
* `olevba` – extracts and analyzes VBA macro source code from MS Office documents (OLE and Open XML)
* `MacroRaptor` – detects malicious VBA Macros
* `msodde` – detects and extracts DDE/DDEAUTO links from MS Office documents, RTF, and CSV files
* `pyxswf` – detects, extracts, and analyzes Flash objects (SWF) that may be embedded in files such as MS Office documents and RTF files, which is especially useful for malware analysis
* `oleobj` – extracts embedded objects from OLE files
* `rtfobj` – extracts embedded objects from RTF files

![image](https://github.com/1NT3L-8642/Malware-Analysis-Writeups/assets/78220748/d972c019-3296-41e3-a02d-d7964fc00ff2)

rtfobj showing embedded objects


#### **Tools to analyze the structure of OLE files**

* `olebrowse` – a simple GUI to browse OLE files (e.g. MS Word, Excel, PowerPoint documents), allowing you to view and extract individual data streams
* `olemeta` – extracts all standard properties (metadata) from OLE files
* `oletimes` – extracts creation and modification timestamps of all streams and storages
* `oledir` – displays all the directory entries of an OLE file, including free and orphaned entries
* `olemap` – displays a map of all the sectors in an OLE file

### **Mitigation**

Patching against the vulnerability should be a priority. However, if you aren't able to patch, mitigation is provided by Microsoft. Setting the [FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION](https://learn.microsoft.com/archive/blogs/ieinternals/internet-explorer-9-0-2-update#new-restrictions-on-use-ofthe-file-protocol) registry key can avoid exploitation of this specific component.


### **Detection**

Sigma rules have been created that can be used to query SIEMS or log collection tools for the presence of known HTTP-based indicators.


```
title: Potential CVE-2023-36884 Exploitation - File Downloads
id: 6af1617f-c179-47e3-bd66-b28034a1052d
status: experimental
description: Detects files seen being requested by RomCom while potentially exploiting CVE-2023-36884
references:
    - https://blogs.blackberry.com/en/2023/07/romcom-targets-ukraine-nato-membership-talks-at-nato-summit
author: X__Junior
date: 2023/07/12
tags:
    - attack.command_and_control
    - cve.2023.36884
logsource:
    category: proxy
detection:
    selection:
        cs-method: 'GET'
        c-uri|contains:
            - '/ex001.url'
            - '/file001.search-ms'
            - '/file001.url'
            - '/file001.vbs'
            - '/file1.mht'
            - '/o2010.asp'
            - '/redir_obj.html'
            - '/RFile.asp'
            - '/zip_k.asp'
            - '/zip_k2.asp'
            - '/zip_k3.asp'
    condition: selection
falsepositives:
    - Unknown
level: medium
```
Source: * [https://github.com/SigmaHQ/sigma/blob/master/rules-emerging-threats/2023/Exploits/CVE-2023-36884/proxy_exploit_cve_2023_36884_office_windows_html_rce_traffic.yml](https://github.com/SigmaHQ/sigma/blob/master/rules-emerging-threats/2023/Exploits/CVE-2023-36884/proxy_exploit_cve_2023_36884_office_windows_html_rce_traffic.yml)
